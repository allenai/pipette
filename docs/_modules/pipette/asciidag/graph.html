

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pipette.asciidag.graph &mdash; Pipette  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Pipette
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pipette.html">pipette package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Pipette</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pipette.asciidag.graph</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pipette.asciidag.graph</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;ASCII representation of directed acyclic graphs (DAGs).</span>

<span class="sd">This is almost a straight port of Git&#39;s graph.c.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="k">import</span> <span class="n">Enum</span>

<span class="kn">from</span> <span class="nn">.color</span> <span class="k">import</span> <span class="n">COLUMN_COLORS_ANSI</span>
<span class="kn">from</span> <span class="nn">.sequence</span> <span class="k">import</span> <span class="n">walk_nodes</span><span class="p">,</span> <span class="n">once</span><span class="p">,</span> <span class="n">sort_in_topological_order</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Graph&#39;</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">Column</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-few-public-methods</span>
    <span class="sd">&quot;&quot;&quot;A single column of output.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        commit -- The parent commit of this column.</span>
<span class="sd">        color  -- The color to (optionally) print this column in.</span>
<span class="sd">                  This is an index into column_colors.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>


<span class="k">class</span> <span class="nc">GraphState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-few-public-methods</span>
    <span class="n">PADDING</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">SKIP</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">PRE_COMMIT</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">COMMIT</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">POST_MERGE</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">COLLAPSING</span> <span class="o">=</span> <span class="mi">5</span>


<span class="c1"># The commit currently being processed</span>
<span class="c1">#         struct commit *commit</span>
<span class="c1">#</span>
<span class="c1"># The number of interesting parents that this commit has.</span>
<span class="c1"># Note that this is not the same as the actual number of parents.</span>
<span class="c1"># This count excludes parents that won&#39;t be printed in the graph</span>
<span class="c1"># output, as determined by is_interesting().</span>
<span class="c1">#         int num_parents</span>
<span class="c1">#</span>
<span class="c1"># The width of the graph output for this commit.</span>
<span class="c1"># All rows for this commit are padded to this width, so that</span>
<span class="c1"># messages printed after the graph output are aligned.</span>
<span class="c1">#         int width</span>
<span class="c1">#</span>
<span class="c1"># The next expansion row to print</span>
<span class="c1"># when state is GraphState.PRE_COMMIT</span>
<span class="c1">#         int expansion_row</span>
<span class="c1">#</span>
<span class="c1"># The current output state.</span>
<span class="c1"># This tells us what kind of line next_line() should output.</span>
<span class="c1">#         enum graph_state state</span>
<span class="c1">#</span>
<span class="c1"># The output state for the previous line of output.</span>
<span class="c1"># This is primarily used to determine how the first merge line</span>
<span class="c1"># should appear, based on the last line of the previous commit.</span>
<span class="c1">#         enum graph_state prev_state</span>
<span class="c1">#</span>
<span class="c1"># The index of the column that refers to this commit.</span>
<span class="c1"># If none of the incoming columns refer to this commit,</span>
<span class="c1"># this will be equal to num_columns.</span>
<span class="c1">#         int commit_index</span>
<span class="c1">#</span>
<span class="c1"># The commit_index for the previously displayed commit.</span>
<span class="c1"># This is used to determine how the first line of a merge</span>
<span class="c1"># graph output should appear, based on the last line of the</span>
<span class="c1"># previous commit.</span>
<span class="c1">#         int prev_commit_index</span>
<span class="c1">#</span>
<span class="c1"># The maximum number of columns that can be stored in the columns</span>
<span class="c1"># and new_columns arrays. This is also half the number of entries</span>
<span class="c1"># that can be stored in the mapping and new_mapping arrays.</span>
<span class="c1">#         int column_capacity</span>
<span class="c1">#</span>
<span class="c1"># The number of columns (also called &quot;branch lines&quot; in some places)</span>
<span class="c1">#         int num_columns</span>
<span class="c1">#</span>
<span class="c1"># The number of columns in the new_columns array</span>
<span class="c1">#         int num_new_columns</span>
<span class="c1">#</span>
<span class="c1"># The number of entries in the mapping array</span>
<span class="c1">#         int mapping_size</span>
<span class="c1">#</span>
<span class="c1"># The column state before we output the current commit.</span>
<span class="c1">#         struct column *columns</span>
<span class="c1">#</span>
<span class="c1"># The new column state after we output the current commit.</span>
<span class="c1"># Only valid when state is GraphState.COLLAPSING.</span>
<span class="c1">#         struct column *new_columns</span>
<span class="c1">#</span>
<span class="c1"># An array that tracks the current state of each</span>
<span class="c1"># character in the output line during state GraphState.COLLAPSING.</span>
<span class="c1"># Each entry is -1 if this character is empty, or a non-negative</span>
<span class="c1"># integer if the character contains a branch line. The value of</span>
<span class="c1"># the integer indicates the target position for this branch line.</span>
<span class="c1"># (I.e., this array maps the current column positions to their</span>
<span class="c1"># desired positions.)</span>
<span class="c1">#</span>
<span class="c1"># The maximum capacity of this array is always</span>
<span class="c1"># sizeof(int) * 2 * column_capacity.</span>
<span class="c1">#         int *mapping</span>
<span class="c1">#</span>
<span class="c1"># A temporary array for computing the next mapping state</span>
<span class="c1"># while we are outputting a mapping line. This is stored as part</span>
<span class="c1"># of the git_graph simply so we don&#39;t have to allocate a new</span>
<span class="c1"># temporary array each time we have to output a collapsing line.</span>
<span class="c1">#         int *new_mapping</span>
<span class="c1">#</span>
<span class="c1"># The current default column color being used. This is</span>
<span class="c1"># stored as an index into the array column_colors.</span>
<span class="c1">#         unsigned short default_column_color</span>
<div class="viewcode-block" id="Graph"><a class="viewcode-back" href="../../../pipette.asciidag.html#pipette.asciidag.graph.Graph">[docs]</a><span class="k">class</span> <span class="nc">Graph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># noqa: E501, D104 pylint: disable=too-many-instance-attributes, too-few-public-methods</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">fh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">first_parent_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">use_color</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">column_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;State machine for processing DAG nodes into ASCII graphs.</span>

<span class="sd">        show_nodes() deals with sorting the nodes from tips down into</span>
<span class="sd">        topological order. It then displays them line-by-line.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">fh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span> <span class="o">=</span> <span class="n">fh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_parent_only</span> <span class="o">=</span> <span class="n">first_parent_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_color</span> <span class="o">=</span> <span class="n">use_color</span>
        <span class="k">if</span> <span class="n">column_colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_colors</span> <span class="o">=</span> <span class="n">COLUMN_COLORS_ANSI</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_colors</span> <span class="o">=</span> <span class="n">column_colors</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expansion_row</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">PADDING</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">PADDING</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_commit_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_new_columns</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Start the column color at the maximum value, since we&#39;ll</span>
        <span class="c1"># always increment it for the first commit we output.</span>
        <span class="c1"># This way we start at 0 for the first commit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_column_color</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_colors</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Graph.show_nodes"><a class="viewcode-back" href="../../../pipette.asciidag.html#pipette.asciidag.graph.Graph.show_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">show_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tips</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show an ASCII DAG for the nodes provided.</span>

<span class="sd">        Nodes are walked and returned without duplicates and then</span>
<span class="sd">        sorted topologically (a requirement of the algorithm). The</span>
<span class="sd">        original Git API is then used internally to display the graph</span>
<span class="sd">        line-by-line, outputting the Node&#39;s content at the relevant</span>
<span class="sd">        point.</span>

<span class="sd">        Args:</span>
<span class="sd">            tips (:obj:`list` of :obj:`Node`): tips of trees to display</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">sort_in_topological_order</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">once</span><span class="p">(</span><span class="n">walk_nodes</span><span class="p">(</span><span class="n">tips</span><span class="p">))))</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_commit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_commit_finished</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_show_remainder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_write_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">col_char</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_colors</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">color</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">col_char</span>
        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_colors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">_interesting_parents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">parent</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_parent_only</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">_get_current_column_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_color</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_column_color</span>

    <span class="k">def</span> <span class="nf">_increment_column_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_column_color</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">default_column_color</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                     <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_colors</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_find_commit_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">commit</span> <span class="o">==</span> <span class="n">commit</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">color</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_column_color</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_insert_into_new_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">mapping_index</span><span class="p">):</span>
        <span class="c1"># If the commit is already in the new_columns list, we don&#39;t need to</span>
        <span class="c1"># add it. Just update the mapping correctly.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_new_columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">commit</span> <span class="o">==</span> <span class="n">commit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">mapping_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">return</span> <span class="n">mapping_index</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="c1"># This commit isn&#39;t already in new_columns. Add it.</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">commit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_commit_color</span><span class="p">(</span><span class="n">commit</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_new_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">mapping_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_new_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_new_columns</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">mapping_index</span> <span class="o">+</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">_update_width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_commit_in_existing_columns</span><span class="p">):</span>
        <span class="c1"># Compute the width needed to display the graph for this commit.</span>
        <span class="c1"># This is the maximum width needed for any row. All other rows</span>
        <span class="c1"># will be padded to this width.</span>
        <span class="c1">#</span>
        <span class="c1"># Compute the number of columns in the widest row:</span>
        <span class="c1"># Count each existing column (self.num_columns), and each new</span>
        <span class="c1"># column added by this commit.</span>
        <span class="n">max_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span>

        <span class="c1"># Even if the current commit has no parents to be printed, it</span>
        <span class="c1"># still takes up a column for itself.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">max_cols</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># We added a column for the current commit as part of</span>
        <span class="c1"># self.num_parents. If the current commit was already in</span>
        <span class="c1"># self.columns, then we have double counted it.</span>
        <span class="k">if</span> <span class="n">is_commit_in_existing_columns</span><span class="p">:</span>
            <span class="n">max_cols</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># Each column takes up 2 spaces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">max_cols</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">_update_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Swap self.columns with self.new_columns</span>
        <span class="c1"># self.columns contains the state for the previous commit,</span>
        <span class="c1"># and new_columns now contains the state for our commit.</span>
        <span class="c1">#</span>
        <span class="c1"># We&#39;ll re-use the old columns array as storage to compute the new</span>
        <span class="c1"># columns list for the commit after this one.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_new_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_new_columns</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Now update new_columns and mapping with the information for the</span>
        <span class="c1"># commit after this one.</span>
        <span class="c1">#</span>
        <span class="c1"># First, make sure we have enough room. At most, there will</span>
        <span class="c1"># be self.num_columns + self.num_parents columns for the next</span>
        <span class="c1"># commit.</span>
        <span class="n">max_new_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span>

        <span class="c1"># Clear out self.mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">max_new_columns</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Populate self.new_columns and self.mapping</span>
        <span class="c1">#</span>
        <span class="c1"># Some of the parents of this commit may already be in</span>
        <span class="c1"># self.columns. If so, self.new_columns should only contain a</span>
        <span class="c1"># single entry for each such commit. self.mapping should</span>
        <span class="c1"># contain information about where each current branch line is</span>
        <span class="c1"># supposed to end up after the collapsing is performed.</span>
        <span class="n">seen_this</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">mapping_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">is_commit_in_columns</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">seen_this</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">is_commit_in_columns</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">col_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">commit</span>

            <span class="k">if</span> <span class="n">col_commit</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">:</span>
                <span class="n">old_mapping_idx</span> <span class="o">=</span> <span class="n">mapping_idx</span>
                <span class="n">seen_this</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commit_index</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interesting_parents</span><span class="p">():</span>
                    <span class="c1"># If this is a merge, or the start of a new</span>
                    <span class="c1"># childless column, increment the current</span>
                    <span class="c1"># color.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_commit_in_columns</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_increment_column_color</span><span class="p">()</span>
                    <span class="n">mapping_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_into_new_columns</span><span class="p">(</span>
                        <span class="n">parent</span><span class="p">,</span>
                        <span class="n">mapping_idx</span><span class="p">)</span>
                <span class="c1"># We always need to increment mapping_idx by at</span>
                <span class="c1"># least 2, even if it has no interesting parents.</span>
                <span class="c1"># The current commit always takes up at least 2</span>
                <span class="c1"># spaces.</span>
                <span class="k">if</span> <span class="n">mapping_idx</span> <span class="o">==</span> <span class="n">old_mapping_idx</span><span class="p">:</span>
                    <span class="n">mapping_idx</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mapping_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_into_new_columns</span><span class="p">(</span><span class="n">col_commit</span><span class="p">,</span>
                                                            <span class="n">mapping_idx</span><span class="p">)</span>

        <span class="c1"># Shrink mapping_size to be the minimum necessary</span>
        <span class="k">while</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># Compute self.width for this commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_width</span><span class="p">(</span><span class="n">is_commit_in_columns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interesting_parents</span><span class="p">()))</span>

        <span class="c1"># Store the old commit_index in prev_commit_index.</span>
        <span class="c1"># update_columns() will update self.commit_index for this</span>
        <span class="c1"># commit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_commit_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_index</span>

        <span class="c1"># Call update_columns() to update</span>
        <span class="c1"># columns, new_columns, and mapping.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_columns</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expansion_row</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Update self.state.</span>
        <span class="c1"># Note that we don&#39;t call update_state() here, since</span>
        <span class="c1"># we don&#39;t want to update self.prev_state. No line for</span>
        <span class="c1"># self.state was ever printed.</span>
        <span class="c1">#</span>
        <span class="c1"># If the previous commit didn&#39;t get to the GraphState.PADDING state,</span>
        <span class="c1"># it never finished its output. Goto GraphState.SKIP, to print out</span>
        <span class="c1"># a line to indicate that portion of the graph is missing.</span>
        <span class="c1">#</span>
        <span class="c1"># If there are 3 or more parents, we may need to print extra rows</span>
        <span class="c1"># before the commit, to expand the branch lines around it and make</span>
        <span class="c1"># room for it. We need to do this only if there is a branch row</span>
        <span class="c1"># (or more) to the right of this commit.</span>
        <span class="c1">#</span>
        <span class="c1"># If there are less than 3 parents, we can immediately print the</span>
        <span class="c1"># commit line.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">PADDING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">SKIP</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">commit_index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">PRE_COMMIT</span>  <span class="c1"># noqa: E501 pylint: disable=redefined-variable-type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">COMMIT</span>

    <span class="k">def</span> <span class="nf">_is_mapping_correct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The mapping is up to date if each entry is at its target,</span>
        <span class="c1"># or is 1 greater than its target.</span>
        <span class="c1"># (If it is 1 greater than the target, &#39;/&#39; will be printed, so it</span>
        <span class="c1"># will look correct on the next row.)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span><span class="p">):</span>
            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_pad_horizontally</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars_written</span><span class="p">):</span>
        <span class="c1"># Add additional spaces to the end of the string, so that all</span>
        <span class="c1"># lines for a particular commit have the same width.</span>
        <span class="c1">#</span>
        <span class="c1"># This way, fields printed to the right of the graph will remain</span>
        <span class="c1"># aligned for the entire commit.</span>
        <span class="k">if</span> <span class="n">chars_written</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">chars_written</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">extra</span>

    <span class="k">def</span> <span class="nf">_output_padding_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Output a padding row, that leaves all branch lines unchanged</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_new_columns</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pad_horizontally</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_new_columns</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_output_skip_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Output an ellipsis to indicate that a portion</span>
        <span class="c1"># of the graph is missing.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39;...&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pad_horizontally</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_state</span><span class="p">(</span><span class="n">GraphState</span><span class="o">.</span><span class="n">PRE_COMMIT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_state</span><span class="p">(</span><span class="n">GraphState</span><span class="o">.</span><span class="n">COMMIT</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_output_pre_commit_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This function formats a row that increases the space around a commit</span>
        <span class="c1"># with multiple parents, to make room for it. It should only be</span>
        <span class="c1"># called when there are 3 or more parents.</span>
        <span class="c1">#</span>
        <span class="c1"># We need 2 extra rows for every parent over 2.</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;not enough parents to add expansion row&#39;</span>
        <span class="n">num_expansion_rows</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="c1"># self.expansion_row tracks the current expansion row we are on.</span>
        <span class="c1"># It should be in the range [0, num_expansion_rows - 1]</span>
        <span class="k">assert</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expansion_row</span> <span class="o">&lt;</span> <span class="n">num_expansion_rows</span><span class="p">),</span> \
            <span class="s1">&#39;wrong number of expansion rows&#39;</span>

        <span class="c1"># Output the row</span>
        <span class="n">seen_this</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">chars_written</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span><span class="p">):</span>
            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">commit</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">:</span>
                <span class="n">seen_this</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">expansion_row</span>
                <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">expansion_row</span>
            <span class="k">elif</span> <span class="n">seen_this</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expansion_row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># This is the first line of the pre-commit output.</span>
                <span class="c1"># If the previous commit was a merge commit and</span>
                <span class="c1"># ended in the GraphState.POST_MERGE state, all branch</span>
                <span class="c1"># lines after self.prev_commit_index were</span>
                <span class="c1"># printed as &quot;\&quot; on the previous line. Continue</span>
                <span class="c1"># to print them as &quot;\&quot; on this line. Otherwise,</span>
                <span class="c1"># print the branch lines as &quot;|&quot;.</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">==</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">POST_MERGE</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prev_commit_index</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
                <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">seen_this</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expansion_row</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
                <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
            <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pad_horizontally</span><span class="p">(</span><span class="n">chars_written</span><span class="p">)</span>

        <span class="c1"># Increment self.expansion_row,</span>
        <span class="c1"># and move to state GraphState.COMMIT if necessary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expansion_row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expansion_row</span> <span class="o">&gt;=</span> <span class="n">num_expansion_rows</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_state</span><span class="p">(</span><span class="n">GraphState</span><span class="o">.</span><span class="n">COMMIT</span><span class="p">)</span>

    <span class="c1"># Draw an octopus merge and return the number of characters written.</span>
    <span class="k">def</span> <span class="nf">_draw_octopus_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Here dashless_commits represents the number of parents</span>
        <span class="c1"># which don&#39;t need to have dashes (because their edges fit</span>
        <span class="c1"># neatly under the commit).</span>
        <span class="n">dashless_commits</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">num_dashes</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">-</span> <span class="n">dashless_commits</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_dashes</span><span class="p">):</span>
            <span class="n">col_num</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dashless_commits</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span><span class="p">[</span><span class="n">col_num</span><span class="p">],</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">col_num</span> <span class="o">=</span> <span class="n">num_dashes</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dashless_commits</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span><span class="p">[</span><span class="n">col_num</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num_dashes</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_output_commit_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa: C901, E501 pylint: disable=too-many-branches</span>
        <span class="c1"># Output the row containing this commit</span>
        <span class="c1"># Iterate up to and including self.num_columns,</span>
        <span class="c1"># since the current commit may not be in any of the existing</span>
        <span class="c1"># columns. (This happens when the current commit doesn&#39;t have any</span>
        <span class="c1"># children that we have already processed.)</span>
        <span class="n">seen_this</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">chars_written</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">seen_this</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">col_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">col_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">commit</span>

            <span class="k">if</span> <span class="n">col_commit</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">:</span>
                <span class="n">seen_this</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span>
                <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">chars_written</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_octopus_merge</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">seen_this</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">seen_this</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># This is a 2-way merge commit.</span>
                <span class="c1"># There is no GraphState.PRE_COMMIT stage for 2-way</span>
                <span class="c1"># merges, so this is the first line of output</span>
                <span class="c1"># for this commit. Check to see what the previous</span>
                <span class="c1"># line of output was.</span>
                <span class="c1">#</span>
                <span class="c1"># If it was GraphState.POST_MERGE, the branch line</span>
                <span class="c1"># coming into this commit may have been &#39;\&#39;,</span>
                <span class="c1"># and not &#39;|&#39; or &#39;/&#39;. If so, output the branch</span>
                <span class="c1"># line as &#39;\&#39; on this line, instead of &#39;|&#39;. This</span>
                <span class="c1"># makes the output look nicer.</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">==</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">POST_MERGE</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prev_commit_index</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
                <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
                <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
            <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pad_horizontally</span><span class="p">(</span><span class="n">chars_written</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_state</span><span class="p">(</span><span class="n">GraphState</span><span class="o">.</span><span class="n">POST_MERGE</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mapping_correct</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_state</span><span class="p">(</span><span class="n">GraphState</span><span class="o">.</span><span class="n">PADDING</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_state</span><span class="p">(</span><span class="n">GraphState</span><span class="o">.</span><span class="n">COLLAPSING</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_new_column_by_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_new_columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">commit</span> <span class="o">==</span> <span class="n">commit</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_output_post_merge_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">seen_this</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">chars_written</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">seen_this</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">col_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">col_commit</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">commit</span>

            <span class="k">if</span> <span class="n">col_commit</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">:</span>
                <span class="c1"># Since the current commit is a merge find</span>
                <span class="c1"># the columns for the parent commits in</span>
                <span class="c1"># new_columns and use those to format the</span>
                <span class="c1"># edges.</span>
                <span class="n">seen_this</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">parents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interesting_parents</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">parents</span><span class="p">,</span> <span class="s1">&#39;merge has no parents&#39;</span>
                <span class="n">par_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_new_column_by_commit</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">parents</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">par_column</span><span class="p">,</span> <span class="s1">&#39;parent column not found&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">par_column</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
                <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;parent is not valid&#39;</span>
                    <span class="n">par_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_new_column_by_commit</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">par_column</span><span class="p">,</span> <span class="s1">&#39;parent column not found&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">par_column</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
                <span class="n">chars_written</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="n">seen_this</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
                <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
                <span class="n">chars_written</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pad_horizontally</span><span class="p">(</span><span class="n">chars_written</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mapping_correct</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_state</span><span class="p">(</span><span class="n">GraphState</span><span class="o">.</span><span class="n">PADDING</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_state</span><span class="p">(</span><span class="n">GraphState</span><span class="o">.</span><span class="n">COLLAPSING</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_output_collapsing_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa: C901, E501 pylint: disable=too-many-branches</span>
        <span class="n">used_horizontal</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">horizontal_edge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">horizontal_edge_target</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Clear out the new_mapping array</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span><span class="p">):</span>
            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Since update_columns() always inserts the leftmost</span>
            <span class="c1"># column first, each branch&#39;s target location should</span>
            <span class="c1"># always be either its current location or to the left of</span>
            <span class="c1"># its current location.</span>
            <span class="c1">#</span>
            <span class="c1"># We never have to move branches to the right. This makes</span>
            <span class="c1"># the graph much more legible, since whenever branches</span>
            <span class="c1"># cross, only one is moving directions.</span>
            <span class="k">assert</span> <span class="n">target</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">,</span> \
                <span class="s1">&#39;position </span><span class="si">{}</span><span class="s1"> targetting column </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">target</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">target</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                <span class="c1"># This column is already in the correct place</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Nothing is to the left. Move to the left by one.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
                <span class="c1"># If there isn&#39;t already an edge moving horizontally</span>
                <span class="c1"># select this one.</span>
                <span class="k">if</span> <span class="n">horizontal_edge</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">horizontal_edge</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">horizontal_edge_target</span> <span class="o">=</span> <span class="n">target</span>
                    <span class="c1"># The variable target is the index of the graph</span>
                    <span class="c1"># column, and therefore target * 2 + 3 is the</span>
                    <span class="c1"># actual screen column of the first horizontal</span>
                    <span class="c1"># line.</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">target</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
                <span class="c1"># There is a branch line to our left</span>
                <span class="c1"># already, and it is our target. We</span>
                <span class="c1"># combine with this line, since we share</span>
                <span class="c1"># the same parent commit.</span>
                <span class="c1">#</span>
                <span class="c1"># We don&#39;t have to add anything to the</span>
                <span class="c1"># output or new_mapping, since the</span>
                <span class="c1"># existing branch line has already taken</span>
                <span class="c1"># care of it.</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># There is a branch line to our left,</span>
                <span class="c1"># but it isn&#39;t our target. We need to</span>
                <span class="c1"># cross over it.</span>
                <span class="c1">#</span>
                <span class="c1"># The space just to the left of this</span>
                <span class="c1"># branch should always be empty.</span>
                <span class="c1">#</span>
                <span class="c1"># The branch to the left of that space</span>
                <span class="c1"># should be our eventual target.</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">target</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
                <span class="c1"># Mark this branch as the horizontal edge to</span>
                <span class="c1"># prevent any other edges from moving</span>
                <span class="c1"># horizontally.</span>
                <span class="k">if</span> <span class="n">horizontal_edge</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">horizontal_edge</span> <span class="o">=</span> <span class="n">i</span>

        <span class="c1"># The new mapping may be 1 smaller than the old mapping</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># Output a line based on the new mapping info</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span><span class="p">):</span>
            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
            <span class="k">elif</span> <span class="n">target</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">target</span> <span class="o">==</span> <span class="n">horizontal_edge_target</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">horizontal_edge</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Set the mappings for all but the</span>
                <span class="c1"># first segment to -1 so that they</span>
                <span class="c1"># won&#39;t continue into the next line.</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="p">(</span><span class="n">target</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">used_horizontal</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">used_horizontal</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">horizontal_edge</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_columns</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pad_horizontally</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_mapping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span>

        <span class="c1"># If self.mapping indicates that all of the branch lines</span>
        <span class="c1"># are already in the correct positions, we are done.</span>
        <span class="c1"># Otherwise, we need to collapse some branch lines together.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mapping_correct</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_state</span><span class="p">(</span><span class="n">GraphState</span><span class="o">.</span><span class="n">PADDING</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_next_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-many-return-statements</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">PADDING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_padding_line</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">SKIP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_skip_line</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">PRE_COMMIT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_pre_commit_line</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">COMMIT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_commit_line</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">POST_MERGE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_post_merge_line</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">COLLAPSING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_collapsing_line</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_padding_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output a padding line in the graph.</span>

<span class="sd">        This is similar to next_line(). However, it is guaranteed to</span>
<span class="sd">        never print the current commit line. Instead, if the commit line is</span>
<span class="sd">        next, it will simply output a line of vertical padding, extending the</span>
<span class="sd">        branch lines downwards, but leaving them otherwise unchanged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">COMMIT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_line</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Output the row containing this commit</span>
        <span class="c1"># Iterate up to and including self.num_columns,</span>
        <span class="c1"># since the current commit may not be in any of the existing</span>
        <span class="c1"># columns. (This happens when the current commit doesn&#39;t have any</span>
        <span class="c1"># children that we have already processed.)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span><span class="p">):</span>
            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">commit</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_parents</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pad_horizontally</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span><span class="p">)</span>

        <span class="c1"># Update self.prev_state since we have output a padding line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_state</span> <span class="o">=</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">PADDING</span>

    <span class="k">def</span> <span class="nf">_is_commit_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">GraphState</span><span class="o">.</span><span class="n">PADDING</span>

    <span class="k">def</span> <span class="nf">_show_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shown_commit_line</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># When showing a diff of a merge against each of its parents, we</span>
        <span class="c1"># are called once for each parent without update having been</span>
        <span class="c1"># called. In this case, simply output a single padding line.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_commit_finished</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_padding</span><span class="p">()</span>
            <span class="n">shown_commit_line</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">shown_commit_line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_commit_finished</span><span class="p">():</span>
            <span class="n">shown_commit_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_line</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">shown_commit_line</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_show_padding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_padding_line</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_show_remainder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shown</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_commit_finished</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_next_line</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">shown</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_commit_finished</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">shown</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Allen Institute for Artificial Intelligence

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>